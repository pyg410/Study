## 명령어 사이클

CPU는 하나의 명령어를 처리하는 과정에 정해진 흐름이 있고, 그 흐름을 반복하며 명령어를 처리한다.
이렇게 하나의 명령어를 처리하는 정형화된 흐름을 `명령어 사이클` 이라고 한다.

### 인출 사이클과 실행 사이클

메모리에 저장된 명령어 하나를 실행한다고 가정해보자.
1. 가장 먼저 명령어를 메모리에서 CPU로 가져와야 한다.

이렇게 메모리에 있는 명령어를 CPU로 가져오는 단계를 `인출 사이클`이라고 한다.(fetch cycle이라고도 한다.)

2. CPU로 명령어를 인출했다면 이제 명령어를 실행한다.

이것이 명령어 사이클의 두 번째 과정이다.
CPU로 가져온 명령어를 실행하는 단계를 `실행 사이클(execution cycle)`이라고 한다.
제어장치가 명령어 레지스터에 담긴 값을 해석하고, 제어 신호를 발생시키는 단계이다.

### 간접 사이클

보통의 명령어 사이클은 `인출 사이클 <-> 간접 사이클` 과 같이 간단하게 실행되지만, 명령어를 인출하여 CPU로 가져왔다고 해서 바로 실행할 수 없는 경우도 있다.

예를 들어 간접 주소 지정 방식의 경우 오퍼랜드 필드에 유효 주소의 주소를 명시한다고 했다.
이 경우 명령어를 인출하여 CPU로 가져왔다고 해도, 명령어를 실행하기 위해 메모리 접근을 한 번 더 해야 한다.
이러한 추가적인 과정을 `간접 사이클(indirect cycle)`이라고 한다.

## 인터럽트

CPU는 정해진 흐름에 따라 명령어를 처리해 가지만, 간혹 이 흐름이 끊어지는 상황이 발생하며 이를 `인터럽트(interrupt)`라고 한다.

`인터럽트는` CPU의 작업을 방해하는 신호이다.

### 동기 인터럽트

CPU에 의해 발생하는 `인터럽트`이다.
CPU가 명령어를 수행하는 도중 예상치 못한 상황에 마주쳤을 때 발생한다.
`ex) 프로그래밍상의 오류`

`동기 인터럽트`는 `예외(Exception)`이라고도 부른다.

#### 예외의 종류

폴트, 트랩, 중단, 소프트웨어 인터럽트로 구성되어 있다.

폴트와 트랩의 경우는 예외를 처리한 후, 예외가 발생한 명령어부터 실행하는지 아니면 예외 발생 명령어 다음 명령어부터 실행하는지에 따라 구분된다.

- 폴트 : 예외 처리 후, 예외가 발생한 명령어부터 실행을 재개하는 예외이다.
- 트랩 : 예외 처리 후, 예외가 발생한 명령어 다음 명령어부터 실행을 재개하는 예외이다.(주로 디버깅에 사용된다.)
- 중단 : CPU가 실행 중인 프로그램을 강제종료할 수 밖에 없는 심각한 오류를 발견했을 때 발생하는 예외.
- 소프트웨어 인터럽트 : 시스템 호출이 발생했을 때 나타난다.

### 비동기 인터럽트

입출력 장치에 의해 발생하는 인터럽트이다.
비동기 인터럽트는 입출력장치의 알림역할을 한다.
`ex) CPU가 입출력장치에 입출력 작업을 부탁한 뒤 작업을 끝낸 입출력 장치가 CPU에 완료 알림인 인터럽트를 보낸다.`

### 비동기 인터럽트 처리 순서

1. 입출력장치는 CPU에 `인터럽트 요청 신호`를 보낸다.
2. CPU는 실행 사이클이 끝나고, 명령어를 인출하기 전 항상 인터럽트 여부를 확인한다.
3. CPU는 인터럽트 요청을 확인하고 `인터럽트 플래그`를 통해 현재 인터럽트를 받아들일 수 있는 지 여부를 확인한다.
4. 인터럽트를 받아들일 수 있으면 CPU는 지금까지 작업을 백업한다.
5. CPU는 `인터럽트 벡터`를 참조하여 `인터럽트 서비스 루틴`을 실행한다.
6. `인터럽트 서비스 루틴` 실행이 끝나면 4에서 백업한 작업을 복구하여 실행을 재개한다.

> 인터럽트 플래그(interrupt flag) : 플래그 레지스터이다. 하드웨어 인터럽트를 받아들일지, 무시할지를 결정하는 플래그 이다. 만약 인터럽트 플래그가 '불가능'으로 설정되어 있다면 CPU는 인터럽트 요청이 오더라도 해당 요청을 무시한다. 반대로 인터럽트 플래그가 '가능'으로 설정되어 있다면 CPU는 인터럽트 요청 신호를 받아들이고 인터럽트를 처리한다.
> 
> 인터럽트 서비스 루틴(ISR : Interrupt Service Routine) : 인터럽트를 처리하기 위한 프로그램이다. 인터럽트 핸들러라고도 불린다. 어떤 인터럽트가 요청왔을 때 어떻게 작동하는지 어떻게 처리하는지에 대한 정보로 이루어져 있다. 인터럽트 서비스 루틴은 메모리에 저장되어 있다.
> 
> 인터럽트 벡터(Interrupt Vector) : 인터럽트 서비스 루틴을 식별하기 위한 정보이다. 인터럽트 서비스 루틴의 시작주소를 알 수 있다. CPU는 인터럽트 요청을 보낸 대상으로부터 데이터 버스를 통해 인터럽트 벡터를 전달받는다.

플래그 레지스터는 다음과 같이 구성되어 있다.

| 부호플래그 | 제로 플래그 | 캐리플래그 | 오버플로우 플래그 | 인터럽트 플래그 | 슈퍼바이저 플래그 |
| ----- | ------ | ----- | --------- | -------- | --------- |

주의할 점으로는, 인터럽트 플래그가 '불가능'이더라도 항상 막을 수 있는 것은 아니다.
하드웨어 고장으로 인한 인터럽트는 가장 먼저 처리해야하기 때문에 무시하지 못한다.

